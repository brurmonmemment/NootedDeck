#include <Headers/Kern_api.hpp>
#include <KextHeaders/NDecK.hpp>
#include <KextHeaders/PatcherPlus.hpp>
#include <KextHeaders/VanGogh/X6000.hpp>

static const char *RadeonX6000 = "/System/Library/Extensions/AMDRadeonX6000.Kext/Contents/MacOS/AMDRadeonX6000";

static KernelPatcher::KextInfo RadeonX6000Kext =
{
    "com.apple.Kext.AMDRadeonX6000",
    &RadeonX6000,
    1,
    {true},
    {},
    KernelPatcher::KextInfo::Unloaded,
};

// Patches

// Mismatched `GetTtlInterface` virtual calls
static const UInt8 KGetTtlInterfaceCallOriginal[]     = {0x40, 0x80, 0x00, 0xFF, 0x90, 0xC8, 0x02, 0x00, 0x00};
static const UInt8 KGetTtlInterfaceCallOriginalMask[] = {0xF0, 0xF0, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
static const UInt8 KGetTtlInterfaceCallPatched[]      = {0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00};
static const UInt8 KGetTtlInterfaceCallPatchedMask[]  = {0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00};

// Mismatched `GetGPUDebugPolicy` virtual calls.
static const UInt8 KGetGPUDebugPolicyCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC0, 0x03, 0x00, 0x00};
static const UInt8 KGetGPUDebugPolicyCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC8, 0x03, 0x00, 0x00};

/* // Seemingly Catalina logic, commented out for now
// Ditto
static const UInt8 KGetGPUDebugPolicyCallOriginal1015[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC8, 0x03, 0x00, 0x00};
static const UInt8 KGetGPUDebugPolicyCallPatched1015[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC0, 0x03, 0x00, 0x00};

// Seemingly Catalina logic, commented out for now
// Ditto
static const UInt8 KHWChannelSubmitCommandBufferOriginal1015[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x20, 0x02, 0x00, 0x00,
    0x49, 0x8B, 0x45};
static const UInt8 KHWChannelSubmitCommandBufferPatched1015[] = {0x48, 0x8B, 0x07, 0x66, 0x90, 0x66, 0x90, 0x66, 0x90,
    0x49, 0x8B, 0x45};
*/

// Mismatched `GetScheduler` virtual calls.
static const UInt8 KGetSchedulerCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xB8, 0x03, 0x00, 0x00};
static const UInt8 KGetSchedulerCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC0, 0x03, 0x00, 0x00};

// Ditto
static const UInt8 KGetSchedulerCallOriginal13[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xB0, 0x03, 0x00, 0x00};
static const UInt8 GetSchedulerCallPatched13[]   = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xB8, 0x03, 0x00, 0x00};

/* // Seemingly Catalina logic, commented out for now
// Ditto
static const UInt8 KGetSchedulerCallOriginal1015[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xC0, 0x03, 0x00, 0x00};
static const UInt8 KGetSchedulerCallPatched1015[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xB8, 0x03, 0x00, 0x00};
*/

// Mismatched `isDeviceValid` virtual calls.
static const UInt8 KIsDeviceValidCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xA0, 0x02, 0x00, 0x00};
static const UInt8 KIsDeviceValidCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x98, 0x02, 0x00, 0x00};

// Mismatched `isDevicePCITunnelled` virtual calls.
static const UInt8 KIsDevicePCITunnelledCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xB0, 0x02, 0x00, 0x00};
static const UInt8 KIsDevicePCITunnelledCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xA8, 0x02, 0x00, 0x00};

// Mismatched `GetSML` virtual calls.
static const UInt8 KGetSMLCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x98, 0x03, 0x00, 0x00};
static const UInt8 KGetSMLCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x90, 0x03, 0x00, 0x00};

// Mismatched `GetUbmSwizzleMode` virtual call in `fillUBMSurface`.
static const UInt8 KGetUbmSwizzleModeCallOriginal[] = {0xFF, 0x91, 0x78, 0x04, 0x00, 0x00};
static const UInt8 KGetUbmSwizzleModeCallPatched[]  = {0xFF, 0x91, 0xA0, 0x04, 0x00, 0x00};

// Mismatched `GetUbmTileMode` virtual call in `fillUBMSurface`.
static const UInt8 KGetUbmTileModeCallOriginal[] = {0xFF, 0x90, 0x80, 0x04, 0x00, 0x00};
static const UInt8 KGetUbmTileModeCallPatched[]  = {0xFF, 0x90, 0xA8, 0x04, 0x00, 0x00};

// Mismatched `WriteWaitForRenderingPipe` virtual call in `WriteUpdateFrameBufferOffsetCommands`.
static const UInt8 KWriteWaitForRenderingPipeCallOriginal[] = {0xFF, 0x90, 0xB8, 0x02, 0x00, 0x00, 0x89, 0x45, 0xAC};
static const UInt8 KWriteWaitForRenderingPipeCallPatched[]  = {0xFF, 0x90, 0xB0, 0x02, 0x00, 0x00, 0x89, 0x45, 0xAC};

// Mismatched `DummyWPTRUpdateDiag` virtual call in `WPTRDiagnostic`.
static const UInt8 KDummyWPTRUpdateDiagCallOriginal[] = {0x48, 0x8B, 0x80, 0x50, 0x02, 0x00, 0x00};
static const UInt8 KDummyWPTRUpdateDiagCallPatched[]  = {0x48, 0x8B, 0x80, 0x48, 0x02, 0x00, 0x00};

// Mismatched `GetPM4CommandsUtility` virtual call in `init`.
static const UInt8 KGetPM4CommandUtilityCallOriginal[] = {0xFF, 0x90, 0xA0, 0x03, 0x00, 0x00};
static const UInt8 KGetPM4CommandUtilityCallPatched[]  = {0xFF, 0x90, 0x98, 0x03, 0x00, 0x00};

// Mismatched `GetChannelDoorbellOffset` virtual call in `allocateMemoryResources`.
static const UInt8 KGetChannelDoorbellOffsetCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x88, 0x03, 0x00, 0x00};
static const UInt8 KGetChannelDoorbellOffsetCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x80, 0x03, 0x00, 0x00};

// Mismatched `GetDoorbellMemoryBaseAddress` virtual call in `allocateMemoryResources`.
static const UInt8 KGetDoorbellMemoryBaseAddressCallOriginal[] = {0xFF, 0x90, 0x80, 0x03, 0x00, 0x00};
static const UInt8 KGetDoorbellMemoryBaseAddressCallPatched[]  = {0xFF, 0x90, 0x78, 0x03, 0x00, 0x00};

// Mismatched `UpdateUtilizationStatisticsCounter` virtual calls.
static const UInt8 KUpdateUtilizationStatisticsCounterCallOriginal[] = {0x41, 0xFF, 0x90, 0xE0, 0x03, 0x00, 0x00};
static const UInt8 KUpdateUtilizationStatisticsCounterCallPatched[]  = {0x41, 0xFF, 0x90, 0xD8, 0x03, 0x00, 0x00};

// Mismatched `DumpASICHangState` virtual calls in `submitCommandBuffer`.
static const UInt8 KDumpASICHangStateCallOriginal[] = {0xFF, 0x90, 0xA8, 0x03, 0x00, 0x00};
static const UInt8 KDumpASICHangStateCallPatched[]  = {0xFF, 0x90, 0xA0, 0x03, 0x00, 0x00};

// Mismatched `RegisterChannel` virtual call in `init`.
static const UInt8 KRegisterChannelCallOriginal[] = {0x4C, 0x89, 0xEE, 0xFF, 0x90, 0x28, 0x03, 0x00, 0x00};
static const UInt8 KRegisterChannelCallPatched[]  = {0x4C, 0x89, 0xEE, 0xFF, 0x90, 0x20, 0x03, 0x00, 0x00};

// Mismatched `DisableGFXOff` virtual calls.
static const UInt8 KDisableGFXOffCallOriginal[] = {0xFF, 0x90, 0x00, 0x04, 0x00, 0x00};
static const UInt8 KDisableGFXOffCallPatched[]  = {0xFF, 0x90, 0xF8, 0x03, 0x00, 0x00};

// Mismatched `enableGFXOff` virtual calls.
static const UInt8 KEnableGFXOffCallOriginal[] = {0xFF, 0x90, 0x08, 0x04, 0x00, 0x00};
static const UInt8 KEnableGFXOffCallPatched[]  = {0xFF, 0x90, 0x00, 0x04, 0x00, 0x00};

// Mismatched `GetHWMemory` virtual calls.
static const UInt8 KGetHWMemoryCallOriginal[] = {0x18, 0x48, 0x8B, 0x07, 0xFF, 0x90, 0xE0, 0x02, 0x00, 0x00, 0x48};
static const UInt8 KGetHWMemoryCallPatched[]  = {0x18, 0x48, 0x8B, 0x07, 0xFF, 0x90, 0xD8, 0x02, 0x00, 0x00, 0x48};

// Mismatched `GetHWGart` virtual calls.
static const UInt8 KGetHWGartCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xE8, 0x02, 0x00, 0x00};
static const UInt8 KGetHWGartCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0xE0, 0x02, 0x00, 0x00};

// Mismatched `GetChannelCount` virtual calls.
static const UInt8 KGetChannelCountCallOriginal[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x38, 0x03, 0x00, 0x00};
static const UInt8 KGetChannelCountCallPatched[]  = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x30, 0x03, 0x00, 0x00};

// Mismatched `FlushSystemCaches` virtual calls.
static const UInt8 KFlushSystemCachesCallOriginal[] = {0xFF, 0x90, 0xA8, 0x04, 0x00, 0x00};
static const UInt8 KFlushSystemCachesCallPatched[]  = {0xFF, 0x90, 0xD0, 0x04, 0x00, 0x00};

// Mismatched `GetIOPCIDevice` virtual calls.
static const UInt8 KGetIOPCIDeviceCallOriginal[] = {0xFF, 0x90, 0x90, 0x03, 0x00, 0x00};
static const UInt8 KGetIOPCIDeviceCallPatched[]  = {0xFF, 0x90, 0x88, 0x03, 0x00, 0x00};

// Mismatched `GetHWRegisters` virtual calls.
static const UInt8 KGetHWRegistersCallOriginal[]     = {0x40, 0x80, 0x00, 0xFF, 0x90, 0xD8, 0x02, 0x00, 0x00};
static const UInt8 KGetHWRegistersCallOriginalMask[] = {0xF0, 0xF0, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
static const UInt8 KGetHWRegistersCallPatched[]      = {0x00, 0x00, 0x00, 0x00, 0x00, 0xD0, 0x00, 0x00, 0x00};
static const UInt8 KGetHWRegistersCallPatchedMask[]  = {0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00};

// Mismatched `GetChannelWriteBackFrameAddr` virtual calls.
static const UInt8 KGetChannelWriteBackFrameAddrCallOriginal[]     = {0xFF, 0x90, 0x50, 0x03, 0x00, 0x00, 0x40};
static const UInt8 KGetChannelWriteBackFrameAddrCallOriginalMask[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0};
static const UInt8 KGetChannelWriteBackFrameAddrCallPatched[]      = {0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00};
static const UInt8 KGetChannelWriteBackFrameAddrCallPatchedMask[]  = {0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00};

// Mismatched `GetChannelWriteBackFrameOffset` virtual calls.
static const UInt8 KGetChannelWriteBackFrameOffsetCall1Original[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x48, 0x03, 0x00,
    0x00};
static const UInt8 KGetChannelWriteBackFrameOffsetCall1Patched[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x40, 0x03, 0x00,
    0x00};

// TODO: Provide an explanation here.
static const UInt8 KGetChannelWriteBackFrameOffsetCall2Original[] = {0x89, 0xDE, 0xFF, 0x90, 0x48, 0x03, 0x00, 0x00};
static const UInt8 KGetChannelWriteBackFrameOffsetCall2Patched[]  = {0x89, 0xDE, 0xFF, 0x90, 0x40, 0x03, 0x00, 0x00};

// Mismatched `GetHWChannel` virtual calls.
static const UInt8 KGetHWChannelCall1Original[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x20, 0x03, 0x00, 0x00, 0x48, 0x85,
    0xC0};
static const UInt8 KGetHWChannelCall1Patched[] = {0x48, 0x8B, 0x07, 0xFF, 0x90, 0x18, 0x03, 0x00, 0x00, 0x48, 0x85,
    0xC0};

// TODO: Provide an explanation here.
static const UInt8 KGetHWChannelCall2Original[] = {0x31, 0xD2, 0xFF, 0x90, 0x18, 0x03, 0x00, 0x00};
static const UInt8 KGetHWChannelCall2Patched[]  = {0x31, 0xD2, 0xFF, 0x90, 0x10, 0x03, 0x00, 0x00};

// TODO: Provide an explanation here.
static const UInt8 KGetHWChannelCall3Original[] = {0x00, 0x00, 0x00, 0xFF, 0x90, 0x18, 0x03, 0x00, 0x00};
static const UInt8 KGetHWChannelCall3Patched[]  = {0x00, 0x00, 0x00, 0xFF, 0x90, 0x10, 0x03, 0x00, 0x00};

// Mismatched `GetHWAlignManager` virtual calls.
static const UInt8 KGetHWAlignManagerCall1Original[]     = {0x48, 0x80, 0x00, 0xFF, 0x90, 0x00, 0x03, 0x00, 0x00};
static const UInt8 KGetHWAlignManagerCall1OriginalMask[] = {0xFF, 0xF0, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
static const UInt8 KGetHWAlignManagerCall1Patched[]      = {0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x02, 0x00, 0x00};
static const UInt8 KGetHWAlignManagerCall1PatchedMask[]  = {0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00};

// TODO: Provide an explanation here.
static const UInt8 KGetHWAlignManagerCall2Original[] = {0x49, 0x89, 0xD4, 0xFF, 0x90, 0x00, 0x03, 0x00, 0x00};
static const UInt8 KGetHWAlignManagerCall2Patched[]  = {0x49, 0x89, 0xD4, 0xFF, 0x90, 0xF8, 0x02, 0x00, 0x00};

// Mismatched `GetHWEngine` virtual calls.
static const UInt8 KGetHWEngineCallOriginal[] = {0x00, 0x00, 0x00, 0xFF, 0x90, 0x10, 0x03, 0x00, 0x00};
static const UInt8 KGetHWEngineCallPatched[]  = {0x00, 0x00, 0x00, 0xFF, 0x90, 0x08, 0x03, 0x00, 0x00};

// Mismatched `GetAMDHWHandler` virtual calls.
static const UInt8 KGetAMDHWHandlerCallOriginal[] = {0xFF, 0x90, 0xD0, 0x02, 0x00, 0x00};
static const UInt8 KGetAMDHWHandlerCallPatched[]  = {0xFF, 0x90, 0xC8, 0x02, 0x00, 0x00};